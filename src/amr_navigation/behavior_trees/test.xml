<root main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">

    <!-- ---- RecoveryNode 規定只能有兩個子節點 ---- -->
    <RecoveryNode number_of_retries="6" name="NavigateRecovery">

      <!-- 子節點 0：導航 + 成功後清理 -->
      <Sequence name="NavigateAndCleanup">

        <!-- 1 Hz 重規劃 + 路徑監控 -->
        <PipelineSequence name="Plan-Monitor-Follow">

          <!-- 1. 規劃 -->
          <RateController hz="1.0">
            <ComputePathToPose goal="{goal}" path="{path}"/>
          </RateController>

          <!-- 2. 檢查路徑 -->
          <ReactiveFallback name="PathCheckAndAct">

            <!-- 2.a 好路徑就跟 -->
            <Sequence name="PathOK_Follow">
              <IsPathValid path="{path}"/>
              <FollowPath path="{path}"/>
            </Sequence>

            <!-- 2.b 壞路徑就「停車 + 清空 path」 -->
            <Sequence name="PathBad_Handle">
              <Inverter><IsPathValid path="{path}"/></Inverter>

              <!-- 方法 1：清 local costmap，讓 controller 立刻失效 -->
              <ClearEntireCostmap
                  name="ClearLocalCostmap"
                  service_name="local_costmap/clear_entirely_local_costmap"/>

              <!-- 方法 2：把 path 清成空物件 → 下一個 tick 外層 Sequence 會自動重規劃 -->
              <SetBlackboard output_key="path" value="{}"/>

              <!-- 稍等 0.3 s，避免 thrash -->
              <Wait wait_duration="0.3"/>
            </Sequence>

          </ReactiveFallback>
        </PipelineSequence>

        <!-- 抵達目標才往下執行 -->
        <GoalReached/>

        <!-- 成功後清 Global costmap -->
        <ClearEntireCostmap
            name="ClearGlobalCostmap"
            service_name="global_costmap/clear_entirely_global_costmap"/>
      </Sequence>

      <!-- 子節點 1：全域補救 -->
      <ReactiveFallback name="RecoveryFallback">
        <GoalUpdated/>
        <RoundRobin name="RecoveryActions">
          <ClearEntireCostmap
              name="ClearLocalAgain"
              service_name="local_costmap/clear_entirely_local_costmap"/>
          <Wait wait_duration="5.0"/>
        </RoundRobin>
      </ReactiveFallback>

    </RecoveryNode>

  </BehaviorTree>
</root>

