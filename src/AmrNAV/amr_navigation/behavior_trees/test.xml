<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">

    <!-- 全域錯誤恢復層 -->
    <RecoveryNode number_of_retries="3" name="NavigateRecovery">

      <!-- 主導航流程 -->
      <Sequence name="PlanOnceAndFollow">

        <!-- 計算路徑（指定 planner plugin） -->
        <ComputePathToPose
          goal="{goal}"
          path="{path}"
          planner_id="GridBased"
        />

        <!-- 檢查路徑有效性 -->
        <IsPathValid path="{path}"/>

        <!-- 跟隨路徑：若失敗，進入 RecoveryNode 執行清 costmap -->
        <RecoveryNode number_of_retries="1" name="FollowPathRecovery">

          <!-- 嘗試跟隨路徑 -->
          <FollowPath
            path="{path}"
            controller_id="MPPI"
            goal_checker_id="goal_checker"
          />

          <!-- Recovery 子行為：清 costmap -->
          <Sequence>
            <ClearEntireCostmap
              name="ClearLocalCostmap-OnFailure"
              service_name="local_costmap/clear_entirely_local_costmap"
            />
          </Sequence>

        </RecoveryNode>

      </Sequence>

      <!-- 導航整體失敗時額外恢復 -->
      <ReactiveFallback name="RecoveryFallback">

        <!-- 檢查是否已更新目標 -->
        <GoalUpdated/>

        <!-- 額外 Recovery 動作 -->
        <RoundRobin name="RecoveryActions">
          <ClearEntireCostmap
            name="ClearLocalCostmap-Subtree"
            service_name="local_costmap/clear_entirely_local_costmap"
          />
        </RoundRobin>

      </ReactiveFallback>

    </RecoveryNode>

  </BehaviorTree>
</root>

